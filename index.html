<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#007AFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CalorieSnap">
    <meta name="application-name" content="CalorieSnap">
    <meta name="mobile-web-app-capable" content="yes">
    <title>CalorieSnap AI</title>
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" href="icons/caloriesnap-icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="icons/caloriesnap-icon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --ios-blue: #007AFF;
        }
        body {
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f2f2f7;
        }
        .ios-blur {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        .loader {
            border-top-color: var(--ios-blue);
            animation: spinner 0.6s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-900 overflow-x-hidden">

    <!-- Header -->
    <header class="sticky top-0 z-30 w-full bg-white/80 ios-blur border-b border-gray-200 pt-[env(safe-area-inset-top)]">
        <div class="px-5 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <button onclick="toggleMealsDrawer()" class="p-2 hover:bg-gray-100 rounded-full transition-colors" aria-label="Open saved meals">
                    <i data-lucide="menu" class="w-6 h-6 text-gray-600"></i>
                </button>
                <h1 class="text-xl font-bold tracking-tight">CalorieSnap <span class="text-blue-600">AI</span></h1>
            </div>
            <button onclick="toggleSettings()" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                <i data-lucide="settings" class="w-6 h-6 text-gray-600"></i>
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto p-5 space-y-6">
        
        <!-- API Key Prompt (Visible if not set) -->
        <div id="setup-card" class="hidden bg-blue-50 border border-blue-100 p-4 rounded-2xl">
            <h2 class="font-semibold text-blue-800 mb-1">Set Up OpenRouter</h2>
            <p class="text-sm text-blue-600 mb-3">To start, enter your OpenRouter API key in settings.</p>
            <button onclick="toggleSettings()" class="text-sm font-bold text-blue-700 underline">Open Settings</button>
        </div>

        <!-- Image Preview Area -->
        <div id="drop-area" class="relative group">
            <input type="file" id="file-input" accept="image/*" capture="environment" class="hidden" onchange="handleImage(event)">
            <label for="file-input" class="block w-full aspect-[4/5] bg-white border-2 border-dashed border-gray-300 rounded-3xl overflow-hidden cursor-pointer active:scale-[0.98] transition-all">
                <div id="preview-placeholder" class="absolute inset-0 flex flex-col items-center justify-center space-y-4 text-gray-400">
                    <div class="p-4 bg-gray-50 rounded-full">
                        <i data-lucide="camera" class="w-12 h-12"></i>
                    </div>
                    <p class="font-medium">Tap to Snap or Upload Food</p>
                </div>
                <img id="image-preview" class="hidden w-full h-full object-cover" />
                <div id="loading-overlay" class="hidden absolute inset-0 bg-white/60 ios-blur flex flex-col items-center justify-center">
                    <div class="loader w-10 h-10 border-4 border-gray-200 rounded-full mb-4"></div>
                    <p class="font-semibold text-gray-700 tracking-wide">Analyzing Nutrition...</p>
                </div>
            </label>
        </div>

        <!-- Action Button -->
        <button id="analyze-btn" onclick="analyzeFood()" disabled class="w-full py-4 bg-blue-600 disabled:bg-gray-300 text-white rounded-2xl font-bold text-lg shadow-lg shadow-blue-200 active:scale-95 transition-all">
            Calculate Calories
        </button>

        <!-- Results Card -->
        <div id="results-card" class="hidden space-y-4 pb-10">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-sm text-gray-500 uppercase font-bold tracking-wider">Estimated Total</p>
                        <h2 class="text-5xl font-black text-gray-900" id="total-calories">0</h2>
                        <p class="text-lg font-medium text-gray-600">Calories</p>
                    </div>
                    <div class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold" id="confidence-tag">
                        AI Estimate
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="font-bold text-gray-800 border-b pb-2">Breakdown</h3>
                    <div id="breakdown-list" class="space-y-3">
                        <!-- Items populated by JS -->
                    </div>
                </div>

                <div class="mt-6 p-4 bg-gray-50 rounded-xl">
                    <p id="description" class="text-sm text-gray-600 leading-relaxed italic"></p>
                </div>
            </div>

            <button id="save-meal-btn" onclick="saveMeal()" disabled class="w-full py-4 bg-white disabled:bg-gray-100 border border-gray-200 disabled:border-gray-200 text-gray-900 disabled:text-gray-400 rounded-2xl font-bold text-lg shadow-sm active:scale-95 transition-all">
                <span class="flex items-center justify-center gap-2">
                    <i data-lucide="bookmark-plus" class="w-5 h-5"></i>
                    Save Meal
                </span>
            </button>
        </div>
    </main>

    <!-- Saved Meals Drawer -->
    <div id="meals-drawer" class="hidden fixed inset-0 z-40">
        <button onclick="toggleMealsDrawer(false)" class="absolute inset-0 bg-black/40" aria-label="Close saved meals overlay"></button>
        <aside class="absolute left-0 top-0 h-full w-[92%] max-w-sm bg-white shadow-2xl border-r border-gray-200 overflow-y-auto pt-[env(safe-area-inset-top)] safe-bottom">
            <div class="px-5 py-4 flex items-center justify-between border-b border-gray-100">
                <div class="flex items-center gap-2">
                    <i data-lucide="calendar-days" class="w-5 h-5 text-gray-700"></i>
                    <h2 class="text-lg font-bold tracking-tight">Saved Meals</h2>
                </div>
                <button onclick="toggleMealsDrawer(false)" class="p-2 hover:bg-gray-100 rounded-full transition-colors" aria-label="Close saved meals">
                    <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
                </button>
            </div>
            <div class="px-5 py-4">
                <div id="saved-meals-content" class="space-y-3"></div>
            </div>
        </aside>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed left-1/2 -translate-x-1/2 bottom-6 z-50 px-4 py-3 rounded-2xl bg-black/80 ios-blur text-white text-sm font-semibold shadow-lg">
        <span id="toast-text"></span>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl animate-in slide-in-from-bottom duration-300">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Settings</h2>
                <button onclick="toggleSettings()" class="text-gray-400"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 tracking-tight">OpenRouter API Key</label>
                    <input type="password" id="api-key-input" placeholder="sk-or-..." class="w-full p-4 bg-gray-100 border-transparent rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                    <p class="text-xs text-gray-500 mt-2 leading-tight">Your key is stored locally on this iPhone and used only for API requests.</p>
                </div>
                <button onclick="saveSettings()" class="w-full py-4 bg-black text-white rounded-xl font-bold active:scale-95 transition-all">
                    Save Configuration
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Icons
        lucide.createIcons();

        let selectedImageBase64 = null;
        let lastMealResult = null;

        // Check for API Key on load
        window.addEventListener('load', () => {
            const key = localStorage.getItem('openrouter_key');
            if (!key) {
                document.getElementById('setup-card').classList.remove('hidden');
            }
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') toggleMealsDrawer(false);
            });
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js').catch((err) => {
                    console.warn('Service worker registration failed', err);
                });
            }
        });

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const input = document.getElementById('api-key-input');
            input.value = localStorage.getItem('openrouter_key') || '';
            modal.classList.toggle('hidden');
        }

        function saveSettings() {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) {
                localStorage.setItem('openrouter_key', key);
                document.getElementById('setup-card').classList.add('hidden');
                toggleSettings();
                alert('Settings saved!');
            }
        }

        function handleImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    // Resize image to max 800px width/height for efficiency
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const max = 800;

                    if (width > height) {
                        if (width > max) { height *= max / width; width = max; }
                    } else {
                        if (height > max) { width *= max / height; height = max; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    selectedImageBase64 = canvas.toDataURL('image/jpeg', 0.8);
                    
                    document.getElementById('image-preview').src = selectedImageBase64;
                    document.getElementById('image-preview').classList.remove('hidden');
                    document.getElementById('preview-placeholder').classList.add('hidden');
                    document.getElementById('analyze-btn').disabled = false;
                    document.getElementById('results-card').classList.add('hidden');
                    document.getElementById('save-meal-btn').disabled = true;
                    lastMealResult = null;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function analyzeFood() {
            const apiKey = localStorage.getItem('openrouter_key');
            if (!apiKey) {
                toggleSettings();
                return;
            }

            const btn = document.getElementById('analyze-btn');
            const loader = document.getElementById('loading-overlay');
            
            btn.disabled = true;
            loader.classList.remove('hidden');

            const prompt = `Analyze this food image. Provide a detailed calorie estimate. 
            Format the response ONLY as a JSON object with this structure:
            {
                "total_calories": number,
                "items": [{"name": "string", "calories": number}],
                "description": "short description of what you see"
            }`;

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href, 
                        "X-Title": "CalorieSnap AI"
                    },
                    body: JSON.stringify({
                        "model": "google/gemini-3-flash-preview", // Fast, cheap, and great at vision
                        "messages": [
                            {
                                "role": "user",
                                "content": [
                                    { "type": "text", "text": prompt },
                                    { "type": "image_url", "image_url": { "url": selectedImageBase64 } }
                                ]
                            }
                        ],
                        "reasoning": {"enabled": true}
                    })
                });

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // Clean markdown if the LLM includes it
                const jsonStr = content.replace(/```json/g, '').replace(/```/g, '').trim();
                const result = JSON.parse(jsonStr);

                displayResults(result);
            } catch (error) {
                console.error(error);
                alert("Error analyzing image. Please check your API key and connection.");
            } finally {
                btn.disabled = false;
                loader.classList.add('hidden');
            }
        }

        function displayResults(data) {
            document.getElementById('total-calories').innerText = data.total_calories;
            document.getElementById('description').innerText = data.description;
            lastMealResult = data;
            
            const list = document.getElementById('breakdown-list');
            list.innerHTML = '';
            
            data.items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-xl';
                div.innerHTML = `
                    <span class="font-medium text-gray-700">${item.name}</span>
                    <span class="font-bold text-blue-600">${item.calories} kcal</span>
                `;
                list.appendChild(div);
            });

            document.getElementById('results-card').classList.remove('hidden');
            document.getElementById('save-meal-btn').disabled = false;
            document.getElementById('results-card').scrollIntoView({ behavior: 'smooth' });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const text = document.getElementById('toast-text');
            text.textContent = message;
            toast.classList.remove('hidden');
            clearTimeout(showToast._timeout);
            showToast._timeout = setTimeout(() => toast.classList.add('hidden'), 1800);
        }

        function generateMealId() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
            return `meal_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        }

        function loadSavedMeals() {
            try {
                const raw = localStorage.getItem('caloriesnap_saved_meals');
                const parsed = raw ? JSON.parse(raw) : [];
                return Array.isArray(parsed) ? parsed : [];
            } catch (err) {
                return [];
            }
        }

        function persistSavedMeals(meals) {
            localStorage.setItem('caloriesnap_saved_meals', JSON.stringify(meals));
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function getLocalDateKey(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function formatDayTitle(dayKey) {
            const [y, m, d] = dayKey.split('-').map(Number);
            const date = new Date(y, (m || 1) - 1, d || 1);
            const todayKey = getLocalDateKey(new Date());
            if (dayKey === todayKey) return 'Today';
            return date.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
        }

        function formatDaySubtitle(dayKey) {
            const [y, m, d] = dayKey.split('-').map(Number);
            const date = new Date(y, (m || 1) - 1, d || 1);
            const todayKey = getLocalDateKey(new Date());
            if (dayKey === todayKey) return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
            const currentYear = new Date().getFullYear();
            if (date.getFullYear() !== currentYear) return String(date.getFullYear());
            return '';
        }

        function safeDomIdFromDayKey(dayKey) {
            return `day_${dayKey.replace(/[^0-9]/g, '')}`;
        }

        function renderSavedMealsDrawer() {
            const container = document.getElementById('saved-meals-content');
            const meals = loadSavedMeals();

            if (!meals.length) {
                container.innerHTML = `
                    <div class="bg-gray-50 border border-gray-100 rounded-2xl p-4">
                        <p class="font-semibold text-gray-800">No saved meals yet</p>
                        <p class="text-sm text-gray-600 mt-1">Analyze a food photo and tap “Save Meal”.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            const groups = new Map();
            for (const meal of meals) {
                const savedAt = meal?.savedAt ? new Date(meal.savedAt) : new Date();
                const dayKey = getLocalDateKey(savedAt);
                if (!groups.has(dayKey)) groups.set(dayKey, []);
                groups.get(dayKey).push(meal);
            }

            const dayKeys = Array.from(groups.keys()).sort((a, b) => b.localeCompare(a));
            const todayKey = getLocalDateKey(new Date());

            container.innerHTML = dayKeys.map((dayKey) => {
                const dayMeals = groups.get(dayKey) || [];
                const total = dayMeals.reduce((sum, meal) => sum + (Number(meal?.total_calories) || 0), 0);
                const dayId = safeDomIdFromDayKey(dayKey);
                const isToday = dayKey === todayKey;
                const defaultOpen = isToday ? 'true' : 'false';
                const subtitle = formatDaySubtitle(dayKey);

                const mealsHtml = dayMeals.map((meal) => {
                    const time = meal?.savedAt
                        ? new Date(meal.savedAt).toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' })
                        : '';
                    const title = (meal?.description || '').trim() || 'Meal';
                    const calories = Number(meal?.total_calories) || 0;
                    return `
                        <div class="flex items-start justify-between gap-3 p-3 bg-white rounded-xl border border-gray-100">
                            <div class="min-w-0">
                                <div class="flex items-center gap-2">
                                    <p class="font-semibold text-gray-900 truncate">${escapeHtml(title)}</p>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">${escapeHtml(time)}</p>
                            </div>
                            <div class="flex items-center gap-2 shrink-0">
                                <div class="text-right">
                                    <p class="font-bold text-blue-600">${calories} kcal</p>
                                </div>
                                <button data-meal-id="${escapeHtml(meal?.id || '')}" onclick="deleteSavedMeal(this.dataset.mealId)" class="p-2 hover:bg-gray-50 rounded-lg transition-colors" aria-label="Delete saved meal">
                                    <i data-lucide="trash-2" class="w-4 h-4 text-gray-500"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <section class="bg-gray-50 border border-gray-100 rounded-2xl overflow-hidden">
                        <button class="w-full px-4 py-4 flex items-center justify-between gap-3 text-left" onclick="toggleDaySection('${dayId}')">
                            <div class="min-w-0">
                                <p class="font-bold text-gray-900">${formatDayTitle(dayKey)}${subtitle ? ` <span class="text-gray-500 font-semibold">${escapeHtml(subtitle)}</span>` : ''}</p>
                                <p class="text-sm text-gray-600 mt-1">${dayMeals.length} meal${dayMeals.length === 1 ? '' : 's'} • <span class="font-bold text-gray-900">${total}</span> kcal</p>
                            </div>
                            <i data-lucide="chevron-down" class="w-5 h-5 text-gray-500 shrink-0"></i>
                        </button>
                        <div id="${dayId}" data-open="${defaultOpen}" class="${isToday ? '' : 'hidden'} px-4 pb-4 space-y-3">
                            ${mealsHtml}
                        </div>
                    </section>
                `;
            }).join('');

            lucide.createIcons();
        }

        function toggleDaySection(dayId) {
            const panel = document.getElementById(dayId);
            if (!panel) return;
            const isOpen = panel.getAttribute('data-open') === 'true';
            panel.setAttribute('data-open', (!isOpen).toString());
            panel.classList.toggle('hidden', isOpen);
        }

        function toggleMealsDrawer(force) {
            const drawer = document.getElementById('meals-drawer');
            const shouldOpen = typeof force === 'boolean' ? force : drawer.classList.contains('hidden');

            if (shouldOpen) {
                renderSavedMealsDrawer();
                drawer.classList.remove('hidden');
                document.documentElement.style.overflow = 'hidden';
                document.body.style.overflow = 'hidden';
            } else {
                drawer.classList.add('hidden');
                document.documentElement.style.overflow = '';
                document.body.style.overflow = '';
            }
        }

        function deleteSavedMeal(mealId) {
            if (!mealId) return;
            const meals = loadSavedMeals();
            const next = meals.filter(m => m?.id !== mealId);
            persistSavedMeals(next);
            renderSavedMealsDrawer();
            showToast('Meal deleted');
        }

        function saveMeal() {
            if (!lastMealResult) {
                alert('No meal to save yet. Analyze an image first.');
                return;
            }

            const savedMeals = loadSavedMeals();
            const meal = {
                id: generateMealId(),
                savedAt: new Date().toISOString(),
                total_calories: lastMealResult.total_calories,
                items: Array.isArray(lastMealResult.items) ? lastMealResult.items : [],
                description: lastMealResult.description || ''
            };

            savedMeals.unshift(meal);
            persistSavedMeals(savedMeals.slice(0, 100));
            showToast('Meal saved');
            const drawer = document.getElementById('meals-drawer');
            if (drawer && !drawer.classList.contains('hidden')) renderSavedMealsDrawer();
        }
    </script>
</body>
</html>
